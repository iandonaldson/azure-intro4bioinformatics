Perfect — here’s a **STAR RNA-Seq container** that uses **apt for OS/system utilities** and **conda (via micromamba)** for bioinformatics tooling, plus a **real smoke test** that:

1. builds a tiny genome index
2. aligns a tiny set of reads
3. verifies outputs

You can drop these files into a repo and build immediately.

---

## 1) `Dockerfile` (STAR RNA-Seq + apt + conda + smoke test)

```dockerfile
# syntax=docker/dockerfile:1.7
ARG UBUNTU_VERSION=22.04
FROM ubuntu:${UBUNTU_VERSION}

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION="1.0.0"

LABEL org.opencontainers.image.title="star-rnaseq" \
      org.opencontainers.image.description="STAR RNA-Seq container (apt + conda) with smoke test" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}"

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC

# --- System dependencies via apt (keep lean) ---
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates curl wget git bash coreutils \
      bzip2 unzip xz-utils \
      locales tzdata \
      tini \
      procps \
      pigz \
      zlib1g \
      rsync \
      less \
    && rm -rf /var/lib/apt/lists/*

RUN locale-gen en_GB.UTF-8
ENV LANG=en_GB.UTF-8 LC_ALL=en_GB.UTF-8

# --- Non-root runtime user (avoids root-owned output files) ---
ARG USERNAME=bio
ARG USER_UID=1000
ARG USER_GID=1000
RUN groupadd --gid ${USER_GID} ${USERNAME} && \
    useradd  --uid ${USER_UID} --gid ${USER_GID} -m -s /bin/bash ${USERNAME}

# --- Standard directories ---
RUN mkdir -p /opt/work /data /opt/tools && \
    chown -R ${USERNAME}:${USERNAME} /opt/work /data /opt/tools

# --- micromamba (conda) ---
ARG MICROMAMBA_VERSION=1.5.10
RUN curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/${MICROMAMBA_VERSION} \
  | tar -xvj -C /usr/local/bin --strip-components=1 bin/micromamba

ENV MAMBA_ROOT_PREFIX=/opt/micromamba
ENV PATH=/opt/micromamba/bin:/opt/tools/bin:$PATH
ENV MAMBA_DOCKERFILE_ACTIVATE=1

# Create conda env
COPY env.yml /tmp/env.yml
RUN micromamba create -y -n rnaseq -f /tmp/env.yml && \
    micromamba clean -a -y && \
    rm -f /tmp/env.yml

SHELL ["/bin/bash", "-lc"]

# Add helper scripts (smoke test + runner)
COPY bin/ /usr/local/bin/
RUN chmod +x /usr/local/bin/* || true

WORKDIR /opt/work
USER ${USERNAME}

ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["bash"]
```

---

## 2) `env.yml` (conda tools: STAR + samtools + QC)

```yaml
name: rnaseq
channels:
  - conda-forge
  - bioconda
dependencies:
  - star=2.7.11b
  - samtools=1.20
  - fastqc=0.12.1
  - multiqc=1.21
  - pigz=2.8
  - python=3.11
  - pip
  - pip:
      - pandas==2.2.2
```

> Note: `pigz` is included both via apt and conda here on purpose — you can remove one later. Keeping it in conda makes it available inside the env regardless of PATH quirks; apt keeps it available even outside the env.

---

## 3) `bin/smoke_test.sh` (fast, real alignment test)

This smoke test is intentionally **self-contained**: it generates a tiny genome and reads, indexes, aligns, and checks outputs.

```bash
#!/usr/bin/env bash
set -euo pipefail

echo "[smoke] Activating conda env..."
source /opt/micromamba/etc/profile.d/micromamba.sh
micromamba activate rnaseq

echo "[smoke] Versions:"
STAR --version
samtools --version | head -n 2
fastqc --version || true
multiqc --version || true

workdir="$(mktemp -d)"
trap 'rm -rf "${workdir}"' EXIT

genome_dir="${workdir}/genome"
reads_dir="${workdir}/reads"
out_dir="${workdir}/out"
mkdir -p "${genome_dir}" "${reads_dir}" "${out_dir}"

echo "[smoke] Writing tiny reference genome..."
cat > "${genome_dir}/tiny.fa" <<'FA'
>chrTiny
ACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGT
ACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGT
ACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGTACGT
FA

echo "[smoke] Building tiny STAR index..."
STAR \
  --runMode genomeGenerate \
  --runThreadN 1 \
  --genomeDir "${genome_dir}/index" \
  --genomeFastaFiles "${genome_dir}/tiny.fa" \
  --genomeSAindexNbases 4 \
  --genomeChrBinNbits 6 \
  > "${out_dir}/star_genomeGenerate.log" 2>&1

echo "[smoke] Writing tiny FASTQ reads..."
# Reads that should map to chrTiny (exact substrings).
cat > "${reads_dir}/r1.fastq" <<'FQ'
@read1
ACGTACGTACGTACGTACGTACGTACGTACGT
+
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
@read2
GTACGTACGTACGTACGTACGTACGTACGTAC
+
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FQ

echo "[smoke] Aligning reads..."
STAR \
  --runThreadN 1 \
  --genomeDir "${genome_dir}/index" \
  --readFilesIn "${reads_dir}/r1.fastq" \
  --outFileNamePrefix "${out_dir}/" \
  --outSAMtype SAM \
  --outSAMunmapped Within \
  > "${out_dir}/star_align.log" 2>&1

test -s "${out_dir}/Aligned.out.sam"

echo "[smoke] Basic output checks..."
# Confirm SAM header + at least one alignment line present
grep -q "^@SQ" "${out_dir}/Aligned.out.sam"
# Count non-header lines
align_lines="$(grep -v '^@' "${out_dir}/Aligned.out.sam" | wc -l | tr -d ' ')"
if [[ "${align_lines}" -lt 1 ]]; then
  echo "[smoke] ERROR: No alignment records found."
  exit 1
fi

echo "[smoke] Convert SAM -> BAM and index (validates samtools too)..."
samtools view -bS "${out_dir}/Aligned.out.sam" > "${out_dir}/Aligned.out.bam"
samtools index "${out_dir}/Aligned.out.bam"
test -s "${out_dir}/Aligned.out.bam"
test -s "${out_dir}/Aligned.out.bam.bai"

echo "[smoke] PASS ✅"
```

---

## 4) `bin/run_star.sh` (simple runner wrapper)

This wrapper makes it easy to run STAR with consistent defaults. You can extend it later (2-pass, gene counts, etc.).

```bash
#!/usr/bin/env bash
set -euo pipefail

source /opt/micromamba/etc/profile.d/micromamba.sh
micromamba activate rnaseq

if [[ $# -lt 6 ]]; then
  cat <<'USAGE'
Usage:
  run_star.sh <genomeDir> <reads1.fq(.gz)> <outPrefix> <threads> <outSAMtype> <extra STAR args...>

Example:
  run_star.sh /data/star_index /data/sample_R1.fastq.gz /opt/work/sample_ 8 BAM SortedByCoordinate --readFilesCommand zcat
USAGE
  exit 2
fi

genome_dir="$1"; shift
reads1="$1"; shift
out_prefix="$1"; shift
threads="$1"; shift
samtype="$1"; shift

STAR \
  --runThreadN "${threads}" \
  --genomeDir "${genome_dir}" \
  --readFilesIn "${reads1}" \
  --outFileNamePrefix "${out_prefix}" \
  --outSAMtype "${samtype}" \
  "$@"
```

---

# 5) Quick-start commands (build, run, administer, update)

## Create the repo structure

```bash
mkdir -p star-rnaseq/{bin,work,data}
cd star-rnaseq

# add Dockerfile, env.yml, bin/smoke_test.sh, bin/run_star.sh
```

## Build the image

```bash
export DOCKER_BUILDKIT=1

docker build \
  --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  --build-arg VCS_REF="$(git rev-parse --short HEAD 2>/dev/null || echo na)" \
  --build-arg VERSION="1.0.0" \
  -t star-rnaseq:1.0.0 .
```

## Run the smoke test (recommended after every build)

```bash
docker run --rm star-rnaseq:1.0.0 bash -lc "smoke_test.sh"
```

## Start an interactive shell with mounts

```bash
docker run --rm -it \
  -v "$PWD/work:/opt/work" \
  -v "$PWD/data:/data" \
  star-rnaseq:1.0.0
```

Inside the container, activate env (if needed):

```bash
micromamba activate rnaseq
STAR --version
```

## Example: build a STAR index (mounted `/data`)

```bash
docker run --rm -it \
  -v "$PWD/data:/data" \
  -v "$PWD/work:/opt/work" \
  star-rnaseq:1.0.0 bash -lc '
    micromamba activate rnaseq
    mkdir -p /data/star_index
    STAR --runMode genomeGenerate --runThreadN 4 \
      --genomeDir /data/star_index \
      --genomeFastaFiles /data/reference.fa \
      --sjdbGTFfile /data/genes.gtf \
      --sjdbOverhang 100
  '
```

## Example: run STAR on reads (gzipped)

```bash
docker run --rm -it \
  -v "$PWD/data:/data:ro" \
  -v "$PWD/work:/opt/work" \
  star-rnaseq:1.0.0 bash -lc '
    run_star.sh /data/star_index /data/sample_R1.fastq.gz /opt/work/sample_ 8 BAM SortedByCoordinate \
      --readFilesCommand zcat \
      --outSAMattributes NH HI AS nM \
      --outFilterMismatchNmax 999 \
      --outFilterMismatchNoverReadLmax 0.04
  '
```

## Admin: see what’s running / clean up

```bash
docker ps
docker ps -a
docker images | head
docker system df
docker builder prune   # clears build cache
```

## Update procedure (best practice)

1. Edit `env.yml` (bump tool versions)
2. Rebuild with a new version tag
3. Run smoke test

```bash
docker build -t star-rnaseq:1.0.1 .
docker run --rm star-rnaseq:1.0.1 bash -lc "smoke_test.sh"
```

If you want a “paranoid” clean rebuild:

```bash
docker build --no-cache -t star-rnaseq:1.0.1 .
```

---

# Small best-practice notes for STAR containers

* Keep the image **tooling-only**; mount big data and references at runtime (`/data`).
* Version everything: `star-rnaseq:1.0.1` rather than `latest` in pipelines.
* The smoke test is deliberately minimal but “real” — it catches broken STAR installs, missing libs, PATH/env issues, and samtools problems.

