Below is a **step-by-step, “click-by-click + command-by-command” protocol** to stand up an **Azure Linux VM** for an RNA-seq alignment workflow (**FASTQ → GRCh38 STAR BAM**) with **specific recommended Azure settings** for bioinformatics.

I’ll assume a single VM (not a cluster) and a typical bulk RNA-seq workload.

---

## Where to start (official links)

```text
Azure portal quickstart (Linux VM): https://learn.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-portal
Create/use SSH keys for Linux VMs:  https://learn.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys
Azure disk types (Premium/Standard/Ultra): https://learn.microsoft.com/en-us/azure/virtual-machines/disks-types
Azure VM sizes overview:            https://learn.microsoft.com/en-us/azure/virtual-machines/sizes/overview
STAR source + build instructions:   https://github.com/alexdobin/STAR
STAR manual (PDF in repo):          https://github.com/alexdobin/STAR/blob/master/doc/STARmanual.pdf
```

(Those are the same resources referenced via citations below.)

---

## Protocol overview (what you’re building)

**Goal:** VM that can (1) download FASTQs + reference, (2) build a STAR genome index, (3) align reads, (4) produce BAM + logs, (5) save outputs back to durable storage.

Key design choices:

* **STAR likes:** *lots of RAM* + *fast scratch disk*.
* **Azure likes:** keep **data + results** on **managed disks or Blob**, use **local ephemeral/NVMe** only for scratch (because it disappears if VM is deallocated).

---

## Step 0 — Choose a sensible VM shape for STAR (recommended settings)

### Minimum workable (small project / test)

* **General purpose** with decent RAM: e.g. **Dsv5** family (balanced CPU/RAM). ([Microsoft Learn][1])
* Aim for **≥ 64 GB RAM** if you might build a GRCh38 STAR index and align at speed (smaller is possible but often painful).

### Better for STAR (memory + fast local scratch)

* **Memory-optimized** VM family (E-series) ([Microsoft Learn][2])
* Or specifically **Ed(v)5 / Eds(v)5** if you want **fast local SSD** plus lots of RAM. ([Microsoft Learn][3])

**Rule of thumb:** pick a size where **RAM is comfortably above your genome index footprint + alignment buffers**. GRCh38 STAR indices are big; 64–128 GB RAM is a common comfort range.

---

## Step 1 — Create VM in Azure Portal (IaaS)

### 1.1 Open VM creation

1. Sign in: `https://portal.azure.com`
2. Go to **Virtual machines** → **Create** → **Azure virtual machine**
   (Your link is fine for the VM blade.)

For the full portal walk-through, Microsoft’s quickstart is here. ([Microsoft Learn][4])

---

## Step 2 — Basics tab (exact settings I recommend)

### 2.1 Subscription + Resource group

* **Resource group:** create a new one, e.g. `rg-rnaseq-star-dev`

### 2.2 Region

* Pick a region close to where you’ll store data (or close to you), and where your desired VM size is available.

### 2.3 Image (Linux distro)

* Choose: **Ubuntu Server 22.04 LTS** (common, stable defaults, broad package availability). ([Microsoft Learn][4])

### 2.4 Size (CPU/RAM)

* Choose an **E-series** (memory optimized) for STAR-heavy runs, or D-series for lighter/cheaper evaluation. ([Microsoft Learn][2])
* If you anticipate many samples / fast turnaround: prefer **Ed(v)5 / Eds(v)5** (memory + fast local SSD). ([Microsoft Learn][3])

### 2.5 Availability options

* If this is a single “compute workstation VM”, **No infrastructure redundancy required** is fine.
* If production/critical, consider Availability Zones (cost/complexity tradeoff).

---

## Step 3 — Administrator account (SSH)

### Recommended: SSH keys (don’t use password for SSH)

* In **Authentication type**, choose **SSH public key**.
* If you need to generate keys: Microsoft’s guide is here. ([Microsoft Learn][5])
* You can also manage SSH keys in the portal (optional). ([Microsoft Learn][6])

**Username example:** `ian` or `azureuser`

---

## Step 4 — Networking tab (secure-but-usable defaults)

### 4.1 Virtual network

* Let Azure create a new VNet for you, e.g. `vnet-rnaseq-dev`, unless you already have one.

### 4.2 Public inbound ports

* Allow **SSH (22)** from **Selected IPs** (ideally *your* IP only).
  Avoid “Any”.

### 4.3 NIC network security group

* “Basic” is fine for a starter VM, but keep inbound rules tight (SSH only).

---

## Step 5 — Disks tab (this matters for STAR)

### 5.1 OS disk

* Choose **Premium SSD** for OS disk (snappier system + better I/O consistency).
  Disk-type comparison: ([Microsoft Learn][7])

### 5.2 Add a dedicated DATA disk (durable storage)

Add a managed data disk for:

* reference genome + STAR index
* FASTQs (if you store locally)
* outputs (BAM, logs)

Recommended disk type:

* **Premium SSD** (good baseline)
* If you expect heavy I/O and want tunable performance: consider **Premium SSD v2** (advanced). ([Microsoft Learn][7])

### 5.3 Use local SSD/NVMe *only for scratch*

If your chosen VM size includes fast local SSD (common in some “d” variants and the Ed* families), use it for:

* temporary decompression
* STAR temp directories
* intermediate files

If you consider **ephemeral OS disk**, note it’s intended for stateless patterns and ties OS reliability to local SSD. ([Microsoft Learn][8])
For bioinformatics workstation-style VMs, I usually keep OS on managed disk and use local SSD as scratch.

---

## Step 6 — Review + Create

* Click **Review + create**
* After validation passes, click **Create**

---

## Step 7 — First login + OS prep

### 7.1 SSH to the VM

From your laptop terminal:

```bash
ssh -i ~/.ssh/<your_key> <username>@<public_ip>
```

### 7.2 Update packages + install essentials

```bash
sudo apt-get update
sudo apt-get -y upgrade
sudo apt-get -y install build-essential git wget curl unzip pigz zlib1g-dev
```

---

## Step 8 — Mount your data disk (durable working volume)

### 8.1 Identify the disk

```bash
lsblk
```

Assume your new disk shows up as `/dev/sdc` (example).

### 8.2 Partition + format + mount

```bash
sudo parted /dev/sdc --script mklabel gpt mkpart primary ext4 0% 100%
sudo mkfs.ext4 -F /dev/sdc1
sudo mkdir -p /data
sudo mount /dev/sdc1 /data
```

### 8.3 Make it persistent

```bash
sudo blkid /dev/sdc1
# copy the UUID, then:
sudo nano /etc/fstab
```

Add a line like:

```text
UUID=<uuid> /data ext4 defaults,nofail 0 2
```

---

## Step 9 — Install STAR

### Option A (simple): build STAR from source (official)

STAR repo + compile instructions are here. ([GitHub][9])

```bash
cd /data
wget https://github.com/alexdobin/STAR/archive/2.7.11b.tar.gz
tar -xzf 2.7.11b.tar.gz
cd STAR-2.7.11b/source
make STAR
sudo cp STAR /usr/local/bin/
STAR --version
```

---

## Step 10 — Get reference genome + annotation (GRCh38)

You need:

* **FASTA** genome (`GRCh38.primary_assembly.genome.fa` or equivalent)
* **GTF** annotation (e.g., GENCODE)

Practical layout:

```bash
mkdir -p /data/ref/GRCh38/{fasta,gtf,star_index}
```

*(I’m not linking a specific FASTA/GTF source here because labs vary: Ensembl vs GENCODE vs iGenomes. If you tell me which you prefer, I’ll give the exact download URLs and a “known-good” pairing.)*

---

## Step 11 — Build STAR genome index (one-time per reference)

```bash
STAR \
  --runThreadN 16 \
  --runMode genomeGenerate \
  --genomeDir /data/ref/GRCh38/star_index \
  --genomeFastaFiles /data/ref/GRCh38/fasta/GRCh38.fa \
  --sjdbGTFfile /data/ref/GRCh38/gtf/genes.gtf \
  --sjdbOverhang 100
```

Notes:

* `--sjdbOverhang` is typically **readLength-1** (so for 101bp reads, use 100). STAR manual covers this parameter. ([GitHub][10])

---

## Step 12 — Move FASTQs onto the VM

Create a project directory:

```bash
mkdir -p /data/projects/rnaseq01/{fastq,align,logs}
```

Copy FASTQs into `/data/projects/rnaseq01/fastq/` using your preferred method:

* `scp`
* `rsync`
* or (better at scale) Azure Blob + `azcopy` (if you’re storing FASTQs in Azure Storage)

---

## Step 13 — Run STAR alignment

Example paired-end command:

```bash
cd /data/projects/rnaseq01

STAR \
  --runThreadN 16 \
  --genomeDir /data/ref/GRCh38/star_index \
  --readFilesIn fastq/sample_R1.fastq.gz fastq/sample_R2.fastq.gz \
  --readFilesCommand pigz -dc \
  --outFileNamePrefix align/sample_ \
  --outSAMtype BAM SortedByCoordinate \
  --outTmpDir /mnt/star_tmp_sample \
  --limitBAMsortRAM 60000000000
```

Tips:

* Put `--outTmpDir` on **fast local SSD** if available (often `/mnt`), otherwise keep it on `/data`.
* `--limitBAMsortRAM` should be sized to your VM memory (example shown for a 64GB-ish box).

---

## Step 14 — Sanity checks + outputs

You should see:

* `align/sample_Aligned.sortedByCoord.out.bam`
* `align/sample_Log.final.out` (very important)
* `align/sample_Log.out`
* `align/sample_SJ.out.tab`

Quick checks:

```bash
ls -lh align/
sed -n '1,80p' align/sample_Log.final.out
```

---

## Step 15 — Save results off-VM (recommended operational practice)

Even if you keep `/data` as durable, it’s good practice to:

* copy BAM + logs to **Blob Storage**
* shut down the VM when idle (cost control)

(If you want, I can give you a clean “Azure Storage + azcopy” pattern next, matching how you expect to share results.)

---

## Step 16 — Cost hygiene (don’t accidentally burn money)

* **Stop (deallocate)** the VM when not in use.
* Keep reference/index on the data disk or blob so you can spin the VM down safely.

---

If you answer just one thing: **what read length and single/paired-end?**
I’ll then pin down:

* the best `--sjdbOverhang`
* recommended `--runThreadN` / memory knobs
* a concrete “good pairing” of GRCh38 FASTA + GTF download links (GENCODE vs Ensembl) and a reproducible directory layout.

[1]: https://learn.microsoft.com/en-us/azure/virtual-machines/sizes/general-purpose/dsv5-series?utm_source=chatgpt.com "Dsv5 size series - Azure Virtual Machines"
[2]: https://learn.microsoft.com/en-us/azure/virtual-machines/sizes/memory-optimized/e-family?utm_source=chatgpt.com "E family VM size series - Azure Virtual Machines"
[3]: https://learn.microsoft.com/en-us/azure/virtual-machines/sizes/memory-optimized/edv5-series?utm_source=chatgpt.com "Edv5 size series - Azure Virtual Machines"
[4]: https://learn.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-portal?utm_source=chatgpt.com "Quickstart: Create a Linux virtual machine in the Azure portal"
[5]: https://learn.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys?utm_source=chatgpt.com "Create and use an SSH key pair for Linux VMs in Azure"
[6]: https://learn.microsoft.com/en-us/azure/virtual-machines/ssh-keys-portal?utm_source=chatgpt.com "Create SSH keys in the Azure portal - Azure Virtual Machines"
[7]: https://learn.microsoft.com/en-us/azure/virtual-machines/disks-types?utm_source=chatgpt.com "Select a disk type for Azure IaaS VMs - managed disks"
[8]: https://learn.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks?utm_source=chatgpt.com "Ephemeral OS disks - Azure Virtual Machines"
[9]: https://github.com/alexdobin/STAR?utm_source=chatgpt.com "alexdobin/STAR: RNA-seq aligner"
[10]: https://github.com/alexdobin/STAR/blob/master/doc/STARmanual.pdf?utm_source=chatgpt.com "STAR/doc/STARmanual.pdf at master · alexdobin/STAR"
